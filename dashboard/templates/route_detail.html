{{define "route_detail.html"}}
{{template "layout" .}}
{{end}}

{{define "content"}}
<div class="page-header">
    <a href="/" class="back-link">&larr; Back to Routes</a>
    <h2>
        <span class="method-badge method-{{.Route.Method}}">{{.Route.Method}}</span>
        {{.Route.Pattern}}
    </h2>
</div>

<div class="stats-row">
    <div class="stat-card">
        <span class="stat-value">{{.Route.TotalRequests}}</span>
        <span class="stat-label">Total Requests</span>
    </div>
    <div class="stat-card">
        <span class="stat-value">{{formatDuration .Route.AvgLatency}}</span>
        <span class="stat-label">Avg Latency</span>
    </div>
    <div class="stat-card">
        <span class="stat-value">{{formatDuration .Route.P95}}</span>
        <span class="stat-label">P95</span>
    </div>
    <div class="stat-card">
        <span class="stat-value">{{formatDuration .Route.P99}}</span>
        <span class="stat-label">P99</span>
    </div>
    <div class="stat-card {{if gt .Route.ErrorRate 10.0}}card-danger{{else if gt .Route.ErrorRate 5.0}}card-warning{{end}}">
        <span class="stat-value">{{formatPercent .Route.ErrorRate}}</span>
        <span class="stat-label">Error Rate</span>
    </div>
    <div class="stat-card">
        <span class="stat-value">{{formatFloat .Route.AvgDBQueries}}</span>
        <span class="stat-label">Avg DB Queries</span>
    </div>
</div>

<div class="grid-2">
    <div class="card">
        <h3>Latency Distribution</h3>
        <canvas id="latencyChart" height="200"></canvas>
    </div>
    <div class="card">
        <h3>Status Code Distribution</h3>
        <canvas id="statusChart" height="200"></canvas>
    </div>
</div>

<div class="card">
    <h3>Top 10 Slowest Requests</h3>
    <table class="data-table">
        <thead>
            <tr>
                <th>Time</th>
                <th>Path</th>
                <th>Status</th>
                <th>Latency</th>
                <th>DB Queries</th>
                <th>Ext Calls</th>
            </tr>
        </thead>
        <tbody>
            {{range .SlowestRequests}}
            <tr class="clickable-row" onclick="window.location='/request/{{.ID}}'">
                <td>{{formatTime .StartTime}}</td>
                <td>{{.Path}}{{if .QueryParams}}?{{.QueryParams}}{{end}}</td>
                <td><span class="status-code {{statusClass .ResponseStatus}}">{{.ResponseStatus}}</span></td>
                <td>{{formatDuration .Latency}}</td>
                <td>{{len .DBQueries}}</td>
                <td>{{len .ExternalCalls}}</td>
            </tr>
            {{end}}
        </tbody>
    </table>
</div>

<div class="card">
    <h3>Recent Requests</h3>
    <table class="data-table">
        <thead>
            <tr>
                <th>Time</th>
                <th>Path</th>
                <th>Status</th>
                <th>Latency</th>
                <th>DB Queries</th>
            </tr>
        </thead>
        <tbody>
            {{range .Requests}}
            <tr class="clickable-row" onclick="window.location='/request/{{.ID}}'">
                <td>{{formatTime .StartTime}}</td>
                <td>{{.Path}}{{if .QueryParams}}?{{.QueryParams}}{{end}}</td>
                <td><span class="status-code {{statusClass .ResponseStatus}}">{{.ResponseStatus}}</span></td>
                <td>{{formatDuration .Latency}}</td>
                <td>{{len .DBQueries}}</td>
            </tr>
            {{end}}
        </tbody>
    </table>
</div>

<script>
// Latency histogram
const latencyCtx = document.getElementById('latencyChart').getContext('2d');
new Chart(latencyCtx, {
    type: 'bar',
    data: {
        labels: [{{range .LatencyBuckets}}"{{.label}}",{{end}}],
        datasets: [{
            label: 'Requests',
            data: [{{range .LatencyBuckets}}{{.count}},{{end}}],
            backgroundColor: 'rgba(99, 102, 241, 0.8)',
            borderColor: 'rgba(99, 102, 241, 1)',
            borderWidth: 1,
            borderRadius: 4
        }]
    },
    options: {
        responsive: true,
        plugins: { legend: { display: false } },
        scales: {
            y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#94a3b8' } },
            x: { grid: { display: false }, ticks: { color: '#94a3b8' } }
        }
    }
});

// Status code pie chart
const statusCtx = document.getElementById('statusChart').getContext('2d');
const statusColors = {
    '200': '#22c55e', '201': '#22c55e', '204': '#22c55e',
    '301': '#3b82f6', '302': '#3b82f6', '304': '#3b82f6',
    '400': '#f59e0b', '401': '#f59e0b', '403': '#f59e0b', '404': '#f59e0b', '422': '#f59e0b',
    '500': '#ef4444', '502': '#ef4444', '503': '#ef4444'
};
new Chart(statusCtx, {
    type: 'doughnut',
    data: {
        labels: [{{range .StatusDist}}"{{.code}}",{{end}}],
        datasets: [{
            data: [{{range .StatusDist}}{{.count}},{{end}}],
            backgroundColor: [{{range .StatusDist}}statusColors['{{.code}}'] || '#6b7280',{{end}}],
            borderWidth: 0
        }]
    },
    options: {
        responsive: true,
        plugins: {
            legend: { position: 'bottom', labels: { color: '#94a3b8' } }
        }
    }
});
</script>
{{end}}
